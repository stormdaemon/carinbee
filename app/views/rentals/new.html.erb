<%# app/views/rentals/new.html.erb %>

<style>
  /* Animation pour le logo abeille sur la carte */
  #smallBeeLogoOnCard {
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.8s ease-in-out;
    pointer-events: none;
    transform-origin: center center;
  }
  .flying-bee-from-card {
    transform: translate(120px, -120px) rotate(360deg) scale(1.3);
    opacity: 0;
  }

  /* Styles pour le logo abeille sur les boutons d'action */
  .small-bee-on-button {
    position: absolute;
    top: -12px;
    right: -12px;
    height: 35px;
    width: auto;
    z-index: 10;
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.8s ease-in-out;
    pointer-events: none;
    transform-origin: center center;
  }
  .flying-bee-from-button {
    transform: translate(120px, -120px) rotate(360deg) scale(1.3);
    opacity: 0;
  }

  /* Animation pour les boutons d'action */
  .action-button {
    position: relative;
    overflow: visible;
    transition: all 0.3s ease;
  }

  .action-button:hover {
    transform: translateY(-2px);
  }

  .btn-success.action-button:hover {
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
  }

  .btn-outline-secondary.action-button:hover {
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
  }

  /* Pr√©venir le scroll horizontal */
  .rental-container {
    overflow-x: hidden;
  }

  .rental-card {
    position: relative;
    overflow: hidden;
  }

  /* Animation de pulsation pour l'abeille au repos */
  @keyframes beePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .bee-pulse {
    animation: beePulse 2s ease-in-out infinite;
  }

  /* Style pour l'image du v√©hicule */
  .vehicle-image {
    border-radius: 10px;
    object-fit: cover;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-height: 250px;
  }

  /* Styles pour le formulaire */
  .form-floating {
    margin-bottom: 1rem;
  }

  .form-control:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
  }

  .form-label {
    font-weight: 600;
    color: #495057;
  }

  /* Style pour le r√©sum√© de la r√©servation */
  .booking-summary {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 15px;
    padding: 1.5rem;
  }

  .price-calculation {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 10px;
    padding: 1rem;
  }

  /* Animation pour les champs de date */
  .date-input-group {
    transition: all 0.3s ease;
  }

  .date-input-group:hover {
    transform: translateY(-2px);
  }

  /* Style pour les messages d'erreur */
  .field_with_errors {
    display: contents;
  }

  .field_with_errors .form-control {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .invalid-feedback {
    display: block;
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.25rem;
  }
</style>

<!-- Main Content Area -->
<div class="container mt-4 mb-4 rental-container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">üöó Nouvelle demande de location</h2>
        <%= link_to "‚Üê Retour", vehicle_path(@vehicle), class: "btn btn-outline-secondary" %>
      </div>

      <div class="row">
        <!-- Colonne du formulaire -->
        <div class="col-lg-7">
          <div class="card shadow-sm p-4 rounded-3 rental-card" style="background-color: #FFFFFF;">

            <img id="smallBeeLogoOnCard" src="https://i.postimg.cc/1Xf6vLRL/image-1-removebg-preview-1.png" alt="Small Bee Logo on Card" class="bee-pulse" style="position: absolute; top: 20px; right: 20px; height: 35px; width: auto;">

            <h4 class="fw-bold mb-4 pt-2">üìù Informations de r√©servation</h4>

            <%= form_with(model: [@vehicle, @rental], local: true, html: { class: "needs-validation", novalidate: true }) do |form| %>

              <!-- Gestion des erreurs -->
              <% if @rental.errors.any? %>
                <div class="alert alert-danger mb-4">
                  <h6 class="fw-bold mb-2">‚ö†Ô∏è Erreurs d√©tect√©es :</h6>
                  <ul class="mb-0">
                    <% @rental.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <!-- Date de d√©but -->
              <div class="date-input-group">
                <div class="form-floating">
                  <%= form.date_field :rental_start_date,
                      class: "form-control #{'is-invalid' if @rental.errors[:rental_start_date].any?}",
                      id: "rental_start_date",
                      min: Date.current,
                      required: true %>
                  <%= form.label :rental_start_date, "üìÖ Date de d√©but", class: "form-label" %>
                  <% if @rental.errors[:rental_start_date].any? %>
                    <div class="invalid-feedback">
                      <%= @rental.errors[:rental_start_date].first %>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Date de fin -->
              <div class="date-input-group">
                <div class="form-floating">
                  <%= form.date_field :rental_end_date,
                      class: "form-control #{'is-invalid' if @rental.errors[:rental_end_date].any?}",
                      id: "rental_end_date",
                      min: Date.current + 1.day,
                      required: true %>
                  <%= form.label :rental_end_date, "üìÖ Date de fin", class: "form-label" %>
                  <% if @rental.errors[:rental_end_date].any? %>
                    <div class="invalid-feedback">
                      <%= @rental.errors[:rental_end_date].first %>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Message optionnel au propri√©taire -->
              <div class="form-floating">
                <%# This assumes @rental has an attribute like :message. Change :message if your attribute is named differently. %>
                <%# Keeping id="message" and explicit for="message" to avoid breaking CSS/JS if they rely on this specific ID. %>
                <%= form.text_area :message,
                    class: "form-control",
                    id: "message",
                    style: "height: 120px;",
                    placeholder: "Message optionnel au propri√©taire..." %>
                <%= form.label :message, "üí¨ Message au propri√©taire (optionnel)", class: "form-label", for: "message" %>
                <small class="text-muted">Pr√©sentez-vous et expliquez pourquoi vous souhaitez louer ce v√©hicule.</small>
              </div>

              <!-- Champs cach√©s -->
              <%= form.hidden_field :status, value: 'pending' %>

              <!-- Boutons d'action -->
              <div class="mt-4 d-flex justify-content-end gap-3">
                <div style="position: relative;">
                  <%= link_to "Annuler", vehicle_path(@vehicle), class: "btn btn-outline-secondary action-button", id: "cancelButton" %>
                  <img class="small-bee-on-button" id="beeOnCancel"
                       src="https://i.postimg.cc/1Xf6vLRL/image-1-removebg-preview-1.png"
                       alt="Small Bee on Cancel Button">
                </div>
                <div style="position: relative;">
                  <%= form.submit "Envoyer la demande", class: "btn btn-success action-button", id: "submitButton" %>
                  <img class="small-bee-on-button" id="beeOnSubmit"
                       src="https://i.postimg.cc/1Xf6vLRL/image-1-removebg-preview-1.png"
                       alt="Small Bee on Submit Button">
                </div>
              </div>

            <% end %>

          </div> <!-- End of form card -->
        </div>

        <!-- Colonne du r√©sum√© -->
        <div class="col-lg-5">
          <!-- Informations sur le v√©hicule -->
          <div class="card shadow-sm mb-4" style="border: 2px solid #f8f9fa;">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">üöó V√©hicule s√©lectionn√©</h5>
            </div>
            <div class="card-body">
              <% if @vehicle.image_url.present? %>
                <%= image_tag @vehicle.image_url, alt: "#{@vehicle.brand} #{@vehicle.model}", class: "img-fluid vehicle-image mb-3" %>
              <% else %>
                <div class="bg-light d-flex align-items-center justify-content-center vehicle-image mb-3" style="height: 200px;">
                  <span class="text-muted fs-4">üöó</span>
                </div>
              <% end %>

              <h5 class="fw-bold mb-3"><%= @vehicle.brand %> <%= @vehicle.model %></h5>

              <div class="row mb-3">
                <div class="col-6">
                  <small class="text-muted">üìç Localisation</small>
                  <p class="mb-1 fw-semibold"><%= @vehicle.localization %></p>
                </div>
                <div class="col-6">
                  <small class="text-muted">üë• Places</small>
                  <p class="mb-1 fw-semibold"><%= @vehicle.number_of_places %></p>
                </div>
                <div class="col-6">
                  <small class="text-muted">üè∑Ô∏è Cat√©gorie</small>
                  <p class="mb-1 fw-semibold"><%= @vehicle.category %></p>
                </div>
                <div class="col-6">
                  <small class="text-muted">‚õΩ Carburant</small>
                  <p class="mb-1 fw-semibold"><%= @vehicle.fuel_type %></p>
                </div>
              </div>

              <div class="price-calculation">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold">üí∞ Prix par jour :</span>
                  <span class="fw-bold text-success fs-5"><%= number_to_currency(@vehicle.daily_price, unit: "‚Ç¨") %></span>
                </div>
              </div>

              <% if @vehicle.description.present? %>
                <div class="mt-3">
                  <small class="text-muted">üìù Description</small>
                  <p class="mb-0 small"><%= truncate(@vehicle.description, length: 150) %></p>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Informations sur le propri√©taire -->
          <div class="card shadow-sm mb-4" style="border: 2px solid #f8f9fa;">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">üë§ Propri√©taire</h5>
            </div>
            <div class="card-body">
              <h6 class="fw-bold mb-2"><%= @vehicle.user.first_name %> <%= @vehicle.user.last_name %></h6>
              <p class="text-muted mb-2">üìß <%= @vehicle.user.email %></p>
              <p class="text-muted mb-3">üìç <%= @vehicle.user.address %></p>
              <%= link_to "Voir le profil complet", user_path(@vehicle.user), class: "btn btn-outline-success btn-sm" %>
            </div>
          </div>

          <!-- R√©sum√© de la r√©servation (calcul√© dynamiquement) -->
          <div class="booking-summary" id="bookingSummary" style="display: none;">
            <h5 class="fw-bold mb-3">üìä R√©sum√© de votre r√©servation</h5>

            <div class="mb-3">
              <div class="d-flex justify-content-between mb-2">
                <span>üìÖ Du :</span>
                <span id="summaryStartDate" class="fw-semibold">-</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>üìÖ Au :</span>
                <span id="summaryEndDate" class="fw-semibold">-</span>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span>‚è±Ô∏è Dur√©e :</span>
                <span id="summaryDuration" class="fw-semibold">-</span>
              </div>
            </div>

            <hr class="my-3">

            <div class="price-calculation">
              <div class="d-flex justify-content-between mb-2">
                <span>üí∞ Prix par jour :</span>
                <span><%= number_to_currency(@vehicle.daily_price, unit: "‚Ç¨") %></span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>üìä Nombre de jours :</span>
                <span id="summaryDays">-</span>
              </div>
              <hr class="my-2">
              <div class="d-flex justify-content-between">
                <span class="fw-bold fs-5">üí≥ Total :</span>
                <span id="summaryTotal" class="fw-bold fs-4 text-success">-</span>
              </div>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              <small>‚ÑπÔ∏è Le prix final sera confirm√© par le propri√©taire lors de l'acceptation de votre demande.</small>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript pour les animations et calculs -->
<script>
  function initializeRentalNewAnimations() {
    const beeLogoOnCard = document.getElementById('smallBeeLogoOnCard');

    // Animation g√©n√©rique pour tous les boutons avec des abeilles
    function initButtonAnimation(buttonId, beeId) {
      const button = document.getElementById(buttonId);
      const bee = document.getElementById(beeId);

      if (button && bee) {
        bee.classList.remove('flying-bee-from-button');
        let isHovering = false;
        let hasFlown = false;

        button.addEventListener('mouseenter', function() {
          if (!isHovering) {
            isHovering = true;
            hasFlown = false;
            // Arr√™ter l'animation de pulsation de l'abeille principale
            if (beeLogoOnCard) beeLogoOnCard.classList.remove('bee-pulse');
          }
          if (!hasFlown) {
            bee.classList.add('flying-bee-from-button');
            hasFlown = true;
          }
        });

        button.addEventListener('mouseleave', function() {
          isHovering = false;
          setTimeout(() => {
            if (!isHovering) {
              bee.classList.remove('flying-bee-from-button');
              // Red√©marrer l'animation de pulsation
              if (beeLogoOnCard) beeLogoOnCard.classList.add('bee-pulse');
              hasFlown = false;
            }
          }, 1000);
        });
      }
    }

    // Initialiser les animations pour tous les boutons
    initButtonAnimation('cancelButton', 'beeOnCancel');
    initButtonAnimation('submitButton', 'beeOnSubmit');
  }

  function initializeDateCalculations() {
    const startDateInput = document.getElementById('rental_start_date');
    const endDateInput = document.getElementById('rental_end_date');
    const bookingSummary = document.getElementById('bookingSummary');
    const dailyPrice = <%= @vehicle.daily_price %>;

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    function calculateAndUpdateSummary() {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;

      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        if (end > start) {
          const timeDiff = end.getTime() - start.getTime();
          const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
          const totalPrice = daysDiff * dailyPrice;

          // Mettre √† jour le r√©sum√©
          document.getElementById('summaryStartDate').textContent = formatDate(startDate);
          document.getElementById('summaryEndDate').textContent = formatDate(endDate);
          document.getElementById('summaryDuration').textContent = daysDiff + ' jour' + (daysDiff > 1 ? 's' : '');
          document.getElementById('summaryDays').textContent = daysDiff;
          document.getElementById('summaryTotal').textContent = totalPrice.toLocaleString('fr-FR') + ' ‚Ç¨';

          // Afficher le r√©sum√©
          bookingSummary.style.display = 'block';
        } else {
          bookingSummary.style.display = 'none';
        }
      } else {
        bookingSummary.style.display = 'none';
      }
    }

    // √âcouter les changements sur les dates
    if (startDateInput && endDateInput) {
      startDateInput.addEventListener('change', calculateAndUpdateSummary);
      endDateInput.addEventListener('change', calculateAndUpdateSummary);

      // Mettre √† jour la date minimum de fin quand la date de d√©but change
      startDateInput.addEventListener('change', function() {
        if (this.value) {
          const nextDay = new Date(this.value);
          nextDay.setDate(nextDay.getDate() + 1);
          endDateInput.min = nextDay.toISOString().split('T')[0];

          // Si la date de fin est ant√©rieure √† la nouvelle date minimum, la r√©initialiser
          if (endDateInput.value && new Date(endDateInput.value) <= new Date(this.value)) {
            endDateInput.value = '';
          }
        }
      });

      // Calcul initial si les dates sont d√©j√† remplies
      calculateAndUpdateSummary();
    }
  }

  function initializeFormValidation() {
    const form = document.querySelector('.needs-validation');
    if (form) {
      form.addEventListener('submit', function(event) {
        const startDate = document.getElementById('rental_start_date').value;
        const endDate = document.getElementById('rental_end_date').value;

        if (!startDate || !endDate) {
          event.preventDefault();
          event.stopPropagation();

          if (!startDate) {
            document.getElementById('rental_start_date').classList.add('is-invalid');
          }
          if (!endDate) {
            document.getElementById('rental_end_date').classList.add('is-invalid');
          }
        } else if (new Date(endDate) <= new Date(startDate)) {
          event.preventDefault();
          event.stopPropagation();
          document.getElementById('rental_end_date').classList.add('is-invalid');
        }

        form.classList.add('was-validated');
      });
    }
  }

  document.addEventListener('turbo:load', function() {
    initializeRentalNewAnimations();
    initializeDateCalculations();
    initializeFormValidation();
  });
</script>
